/*
 * ad_landing.js
 * Javascript associated with ad landing pages.
 */

(function(){
  /*
   * Google Analytics Event Tracking
   *
   * Stackholders would like to know when users submit the more info form on ad landing pages.
   * The tricky part is the form is dynamically generated by a script tag which pulls Javascript
   * from an Admissions application, Slate. When a user submits the form, there is not a new
   * page request, but rather the form gets replaces dynamically by a Thank You html block.
   *
   * So in order to know when a user submits the form -- and track that in Google Analytics --
   * we need to capture that event. This is where this script comes in. It adds an event
   * handler to the form, which is added to the DOM after page load, and has that handler notify
   * Anaylytics whenever the form is submitted.
   *
   * References
   * - https://developers.google.com/analytics/devguides/collection/analyticsjs/events
   * - https://stackoverflow.com/a/37865088/6763239
   *
   * TODO:
   * First iteration will trigger GA event on form submit. This could create false positives
   * if form is not submitted because of missing fields. In that case, it may be possible
   * to trigger GA event on success AJAX request using: http://api.jquery.com/ajaxSuccess/
   */
  var SLATE_FORM_SELECTOR = 'div.ad-landing-masthead form';
  var SLATE_BUTTON_SELECTOR = 'div.ad-landing-masthead form button';
  var GA_GOAL_CATEGORY = 'AdLanding';
  var GA_GOAL_ACTION = 'SubmitClicked';

  // Is form detected after dynamic load? Check every 5 seconds.
  // A: Yes all are detected.
  setInterval(function() {
    console.debug(SLATE_FORM_SELECTOR, 'present?', $(SLATE_FORM_SELECTOR).length);
    console.debug(SLATE_BUTTON_SELECTOR, 'present?', $(SLATE_BUTTON_SELECTOR).length);
    console.debug('Any form present?', $('form').length);
  }, 5000);

  // Not detected (when tested on production test page.)
  $(document).on('submit', SLATE_FORM_SELECTOR, function(event) {
    console.debug('Form submission event detected:', event);
  });

  // Not detected.
  $(document).ajaxSuccess(function(event) {
    console.debug('Successful AJAX event detected:', event);
  });

  // Ding ding ding. Detected!
  $(document).on('click', SLATE_BUTTON_SELECTOR, function(event) {
    console.debug('Form button click event detected:', event);

    // Custom goal set in Google Analytics.
    ga('send', 'event', {
        'eventCategory': GA_GOAL_CATEGORY,
        'eventAction': GA_GOAL_ACTION,
        'hitCallback': function() { console.log('GA hit callback!'); }
    });
  });
})();